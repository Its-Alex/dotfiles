{{ if eq .chezmoi.osRelease.id "arch" -}}
#!/usr/bin/env bash
set -euo pipefail

sudo pacman -S --noconfirm --needed gnupg bitwarden-cli jq

{{ if and (ne (env "CHEZMOI_PASSWORD_MANAGER_DISABLED") "true") (ne (env "CHEZMOI_PASSWORD_MANAGER_DISABLED") "1") -}}
# Login to bitwarden if not logged
if [[ "$(bw status | jq -r .status)" == "unauthenticated" ]]; then
    BW_SESSION=$(bw login --raw)
# Unlock bitwarden if locked
elif [[ "$(bw status | jq -r .status)" == "locked" ]]; then
    BW_SESSION=$(bw unlock --raw)
fi

# Import gpg key
BW_SESSION=$BW_SESSION bw get attachment --itemid e1ac83ba-e272-4b58-90eb-ae4c009cf0f7 --raw kb3rqexmcioe8716h20kgjlqsaqw197f | GPG_TTY=$(tty) gpg --import -
# Import ssh key
mkdir -p ~/.ssh
BW_SESSION=$BW_SESSION bw get attachment --itemid cc6b586b-67e2-47de-b512-b2a300fa609d --raw ylqov46m2iefge0tfotabpoh784h103w > ~/.ssh/itsalex
BW_SESSION=$BW_SESSION bw get attachment --itemid cc6b586b-67e2-47de-b512-b2a300fa609d --raw eocpi3tj9nfsbr6w4bkbrjgwgy2sdx1d > ~/.ssh/itsalex.pub
BW_SESSION=$BW_SESSION bw get attachment --itemid 1cce863d-3878-44f9-ba25-ae4c009cf0f7 --raw pnqu8cj49fufppd97ybrqhz07dseabjm > ~/.ssh/itsalex-old
BW_SESSION=$BW_SESSION bw get attachment --itemid 1cce863d-3878-44f9-ba25-ae4c009cf0f7 --raw 9ckzux864aa3l0lhdc3tyudf150hf91n > ~/.ssh/itsalex-old.pub
chmod 600 ~/.ssh/itsalex
chmod 644 ~/.ssh/itsalex.pub
chmod 600 ~/.ssh/itsalex-old
chmod 644 ~/.ssh/itsalex-old.pub
{{ end -}}
{{ end -}}
